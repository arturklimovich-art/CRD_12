"""
???? ????????????? roadmap (blocks, tasks, steps)
??????: E1-B0-T4
"""
import sys
from pathlib import Path
sys.path.insert(0, '/app/src')

from engineer_b_api.sot.yaml_sync import YAMLSyncEngine

def test_sync_domain_roadmap():
    """????????? ????????????? roadmap ??????"""
    
    print("=" * 70)
    print("????: ????????????? roadmap (blocks ? tasks ? steps)")
    print("=" * 70)
    
    # ?????????????
    dsn = "postgresql://crd_user:crd12@crd12_pgvector:5432/crd12"
    workspace = Path("/app")
    
    engine = YAMLSyncEngine(dsn, workspace)
    
    try:
        # ???? 1: ????????????? roadmap ENG
        print("\n?? ???? 1: ????????????? roadmap ?????? ENG...")
        result_eng = engine.sync_domain_roadmap("ENG")
        
        if result_eng["status"] == "success":
            print(f"   ? SUCCESS")
            print(f"   Blocks synced:  {result_eng['stats']['blocks']}")
            print(f"   Tasks synced:   {result_eng['stats']['tasks']}")
            print(f"   Steps synced:   {result_eng['stats']['steps']}")
            print(f"   Changes: {len(result_eng['changes'])}")
        else:
            print(f"   ? FAIL: {result_eng.get('error')}")
            return False
        
        # ???? 2: ????????????? roadmap TL
        print("\n?? ???? 2: ????????????? roadmap ?????? TL...")
        result_tl = engine.sync_domain_roadmap("TL")
        
        if result_tl["status"] == "success":
            print(f"   ? SUCCESS")
            print(f"   Blocks synced:  {result_tl['stats']['blocks']}")
            print(f"   Tasks synced:   {result_tl['stats']['tasks']}")
            print(f"   Steps synced:   {result_tl['stats']['steps']}")
            print(f"   Changes: {len(result_tl['changes'])}")
        else:
            print(f"   ? FAIL: {result_tl.get('error')}")
            return False
        
        # ???? 3: ???????? ?????? ? ??
        print("\n?? ???? 3: ???????? ?????? ? ??...")
        cur = engine.conn.cursor()
        
        # ?????????? ??????
        cur.execute("SELECT COUNT(*) FROM eng_it.roadmap_blocks")
        blocks_count = cur.fetchone()[0]
        print(f"   ?????? ? ??:     {blocks_count}")
        
        # ?????????? ?????
        cur.execute("SELECT COUNT(*) FROM eng_it.roadmap_tasks")
        tasks_count = cur.fetchone()[0]
        print(f"   ????? ? ??:      {tasks_count}")
        
        # ?????????? ?????
        cur.execute("SELECT COUNT(*) FROM eng_it.roadmap_steps")
        steps_count = cur.fetchone()[0]
        print(f"   ????? ? ??:      {steps_count}")
        
        # ???? 4: ???????? ?????????? ???????
        print("\n?? ???? 4: ???????? ????? ?????? ENG (B0)...")
        cur.execute("""
            SELECT t.code, t.title, t.status
            FROM eng_it.roadmap_tasks t
            JOIN eng_it.roadmap_blocks b ON t.block_id = b.id
            WHERE b.domain_code = 'ENG' AND b.code = 'B0'
            ORDER BY t.task_id
        """)
        rows = cur.fetchall()
        
        if rows:
            print(f"   ??????? ????? ????? B0: {len(rows)}")
            for code, title, status in rows:
                status_icon = "?" if status == "completed" else "??" if status == "in_progress" else "??"
                print(f"   {status_icon} {code}: {title} ({status})")
        else:
            print("   ??  ?????? ?? ???????")
        
        cur.close()
        
        print("\n" + "=" * 70)
        print("? ??? ????? ????????")
        print("=" * 70)
        
        return True
        
    except Exception as e:
        print(f"\n? ??????: {e}")
        import traceback
        traceback.print_exc()
        return False
    finally:
        engine.close()

if __name__ == "__main__":
    success = test_sync_domain_roadmap()
    sys.exit(0 if success else 1)
