# -*- coding: utf-8 -*-
import sys
sys.path.insert(0, '/app')

from patch_manager import PatchManager
import os

DB_DSN = os.getenv("DATABASE_URL", "postgres://crd_user:crd12@crd12_pgvector:5432/crd12")

print("=" * 60)
print("?? TEST: PatchManager.create_patch_from_generated_code")
print("=" * 60)

# ???????? ??????
test_code = """
def test_function():
    '''Test function from PatchManager'''
    return "Hello from automated patch!"
"""

target_file = "agents/test_patch_manager_module.py"
task_id = "test_task_patch_manager_001"

try:
    # ???????? PatchManager
    print("\n1?? ???????? PatchManager...")
    pm = PatchManager(db_dsn=DB_DSN)
    print("   ? PatchManager ??????")
    
    # ???????? ?????
    print("\n2?? ???????? ????? ?? ???????????????? ????...")
    patch_id, approve_token = pm.create_patch_from_generated_code(
        target_file=target_file,
        generated_code=test_code,
        task_id=task_id,
        author="test_user"
    )
    
    print(f"   ? ???? ??????!")
    print(f"      Patch ID: {patch_id}")
    print(f"      Approve Token: {approve_token}")
    print(f"      Target File: {target_file}")
    
    # ???????? ????? ?????
    print("\n3?? ???????? ????? ?????...")
    patch_file = f"/app/workspace/patches_applied/{patch_id}.patch"
    if os.path.exists(patch_file):
        print(f"   ? ???? ??????????: {patch_file}")
        with open(patch_file, 'r') as f:
            content = f.read()
            print(f"      ??????: {len(content)} bytes")
    else:
        print(f"   ? ???? ?? ??????: {patch_file}")
    
    print("\n" + "=" * 60)
    print("? ???? ???????? ???????")
    print("=" * 60)
    
except Exception as e:
    print(f"\n? ?????? ?????: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)
