version: '3.8'

services:
  pgvector:
    image: pgvector/pgvector:pg16
    container_name: crd12_pgvector
    environment:
      POSTGRES_DB: crd12
      POSTGRES_USER: crd_user
      POSTGRES_PASSWORD: crd12
      TZ: Europe/Oslo
    ports:
      - "5433:5432"
    volumes:
      - crd12_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U crd_user -d crd12"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  bot:
    build: ./src/bot
    image: crd12_bot_local:latest
    container_name: crd12_bot
    environment:
      DATABASE_URL: postgres://crd_user:crd12@pgvector:5432/crd12
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      ENGINEER_B_API_URL: http://engineer_b_api:8000
      SELF_BUILDING_MODE: "true"
      POST_DEPLOY_VALIDATE: "true"
      TZ: Europe/Oslo
      PYTHONUNBUFFERED: "1"
    volumes:
      # КРИТИЧЕСКИ ВАЖНО: синхронизация кода бота с хостом
      - ./src/bot:/app
      - ./docker_volumes/bot/logs:/var/log
    depends_on:
      pgvector:
        condition: service_healthy
    restart: unless-stopped
    command: bash /app/start_both.sh

  engineer_b_api:
    build: ./src/engineer_b_api
    image: crd12_engineer_b_api_local:latest
    container_name: crd12_engineer_b_api
    environment:
      DATABASE_URL: postgres://crd_user:crd12@crd12_pgvector:5432/crd12
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL_NAME: ${OPENAI_MODEL_NAME:-gpt-5-thinking}
      TZ: Europe/Oslo
    ports:
      - "8001:8000"
      - "8031:8030"
    volumes:
      # КРИТИЧЕСКИ ВАЖНО: синхронизация кода API с хостом
      - ./src/engineer_b_api:/app
      # Workspace директории
      - ./docker_volumes/engineer_b_api/patches:/app/workspace/patches
      - ./docker_volumes/engineer_b_api/reports:/app/workspace/reports
      - ./docker_volumes/engineer_b_api/snapshots:/app/workspace/snapshots
      - ./docker_volumes/engineer_b_api/adr:/app/workspace/ADR
      - ./docker_volumes/engineer_b_api/logs:/app/workspace/logs
      - ./docker_volumes/engineer_b_api/patches_applied:/app/workspace/patches_applied
      - ./docker_volumes/engineer_b_api/agents:/app/agents
    depends_on:
      pgvector:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  deepseek_proxy:
    build: ./src/app/deepseek_proxy
    image: crd12_deepseek_proxy_local:latest
    container_name: crd12_deepseek_proxy
    environment:
      TZ: Europe/Oslo
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
    ports:
      - "8010:8010"
    restart: unless-stopped

volumes:
  crd12_pgdata:
    name: crd12_pgdata

