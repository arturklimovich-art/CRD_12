"""
??????????? ???????-??????
????????? ????????? ?? ???????????? ??????
"""
from typing import List, Dict
from demo_data import generate_demo_ohlcv
from simple_strategy import SMAStrategy

class Backtester:
    """??????? ???????-??????"""
    
    def __init__(self, strategy):
        self.strategy = strategy
        self.trades = []
        self.equity = []
        self.initial_capital = 10000.0
        self.capital = self.initial_capital
    
    def run(self, data: List[Dict]) -> Dict:
        """
        ????????? ???????
        
        Returns:
            Dict ? ????????????
        """
        history = []
        
        for i, bar in enumerate(data):
            history.append(bar)
            
            signal = self.strategy.on_bar(bar, history)
            
            if signal:
                self.trades.append({
                    "timestamp": bar["timestamp"],
                    "action": signal["action"],
                    "price": signal["price"],
                    "pnl": signal.get("pnl", 0.0)
                })
                
                if signal["action"] == "SELL":
                    self.capital += signal["pnl"]
            
            self.equity.append(self.capital)
        
        return self._calculate_metrics()
    
    def _calculate_metrics(self) -> Dict:
        """????????? ??????? ??????????"""
        total_pnl = self.capital - self.initial_capital
        total_trades = len([t for t in self.trades if t["action"] == "SELL"])
        winning_trades = len([t for t in self.trades if t["action"] == "SELL" and t["pnl"] > 0])
        
        win_rate = (winning_trades / total_trades * 100) if total_trades > 0 else 0
        
        return {
            "initial_capital": self.initial_capital,
            "final_capital": self.capital,
            "total_pnl": total_pnl,
            "total_trades": total_trades,
            "winning_trades": winning_trades,
            "win_rate": win_rate,
            "trades": self.trades
        }

if __name__ == "__main__":
    print("=" * 60)
    print("TradLab - ??????????? ???????")
    print("=" * 60)
    
    # ?????????? demo-??????
    print("\n1. ????????? demo-?????? (200 ??????)...")
    data = generate_demo_ohlcv(bars=200, start_price=50000.0, volatility=0.03)
    print(f"   ? ????????????? {len(data)} ??????")
    
    # ??????? ?????????
    print("\n2. ????????????? ????????? (SMA 10/30)...")
    strategy = SMAStrategy(fast_period=10, slow_period=30)
    print("   ? ????????? ???????")
    
    # ????????? ???????
    print("\n3. ?????? ????????...")
    backtester = Backtester(strategy)
    results = backtester.run(data)
    print("   ? ??????? ????????")
    
    # ??????? ??????????
    print("\n" + "=" * 60)
    print("??????????")
    print("=" * 60)
    print(f"????????? ???????:  ${results['initial_capital']:,.2f}")
    print(f"???????? ???????:   ${results['final_capital']:,.2f}")
    print(f"???????/??????:     ${results['total_pnl']:,.2f} ({results['total_pnl']/results['initial_capital']*100:.2f}%)")
    print(f"????? ??????:       {results['total_trades']}")
    print(f"?????????? ??????:  {results['winning_trades']}")
    print(f"Win Rate:           {results['win_rate']:.2f}%")
    
    if results['trades']:
        print("\n????????? 5 ??????:")
        for trade in results['trades'][-5:]:
            action_symbol = "??" if trade["action"] == "BUY" else "??"
            pnl_str = f" (PnL: ${trade['pnl']:.2f})" if trade["action"] == "SELL" else ""
            print(f"  {action_symbol} {trade['timestamp']} | {trade['action']} @ ${trade['price']:.2f}{pnl_str}")
    
    print("=" * 60)
    
    if results['total_pnl'] > 0:
        print("? SUCCESS: ????????? ?????????!")
    else:
        print("??  INFO: ????????? ???????? (?? ??? ????? ??? demo-??????)")
