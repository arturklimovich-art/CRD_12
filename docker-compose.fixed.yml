services:
  pgvector:
    image: pgvector/pgvector:pg16
    container_name: crd12_pgvector
    environment:
      POSTGRES_DB: crd12
      POSTGRES_USER: crd_user
      POSTGRES_PASSWORD: crd12
      TZ: ${TZ:-Europe/Oslo}
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 5s

  deepseek_proxy:
    image: python:3.11
    container_name: crd12_deepseek_proxy
    volumes:
      - ./deepseek_fixed.py:/app/deepseek_fixed.py
    command: python /app/deepseek_fixed.py
    ports:
      - "8010:8010"
    restart: unless-stopped

  engineer_b_api:
    build:
      context: ./src/app/engineer_b_api
      dockerfile: Dockerfile
    container_name: crd12_engineer_b_api
    environment:
      TZ: ${TZ:-Europe/Oslo}
      DATABASE_URL: ${DATABASE_URL:-postgres://crd_user:crd12@pgvector:5432/crd12}
      DEEPSEEK_PROXY_URL: ${DEEPSEEK_PROXY_URL:-http://deepseek_proxy:8010/llm/complete}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      DEEPSEEK_API_BASE: ${DEEPSEEK_API_BASE}
      DEEPSEEK_MODEL: ${DEEPSEEK_MODEL}
    depends_on:
      pgvector:
        condition: service_healthy
      deepseek_proxy:
        condition: service_started
    ports:
      - "8000:8000"
    restart: unless-stopped

  bot:
    build:
      context: ./src/bot
      dockerfile: Dockerfile
    container_name: crd12_bot
    environment:
      TZ: ${TZ:-Europe/Oslo}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      ENGINEER_B_API_URL: ${ENGINEER_B_API_URL:-http://engineer_b_api:8000}
    depends_on:
      engineer_b_api:
        condition: service_healthy
    restart: unless-stopped
