# -*- coding: utf-8 -*-
"""
?????????????? ???? ?????? ??????? PatchManager + PatchApplier
"""
import sys
sys.path.insert(0, '/app')

from patch_applier import apply_code_with_fallback
import os

print("=" * 60)
print("?? ?????????????? ????: PatchApplier + PatchManager")
print("=" * 60)

# ???????? ??????
test_code = '''
def integration_test_function():
    """Full integration test from PatchApplier"""
    return "SUCCESS: Full chain works!"
'''

target_file = "agents/integration_test.py"
task_id = "integration_test_final"

# ???????? ?????? ? ??
import psycopg2
DB_DSN = os.getenv("DATABASE_URL", "postgres://crd_user:crd12@crd12_pgvector:5432/crd12")

try:
    conn = psycopg2.connect(DB_DSN)
    with conn.cursor() as cur:
        cur.execute("""
            INSERT INTO eng_it.tasks (id, title, status)
            VALUES (%s, 'Integration Test Final', 'in_progress')
            ON CONFLICT (id) DO UPDATE SET status = 'in_progress'
        """, (task_id,))
        conn.commit()
    conn.close()
    print(f"? ?????? {task_id} ???????/?????????")
except Exception as e:
    print(f"? ?????? ???????? ??????: {e}")
    sys.exit(1)

# ???? ?????????? ????
print(f"\n?? ?????????? ???? ????? PatchApplier...")
success, message, result_id = apply_code_with_fallback(
    target_file=target_file,
    generated_code=test_code,
    task_id=task_id
)

print(f"\n{'?' if success else '?'} ?????????: {message}")
print(f"   Result ID: {result_id}")

if success:
    print("\n" + "=" * 60)
    print("?? ?????????????? ???? ???????!")
    print("=" * 60)
    sys.exit(0)
else:
    print("\n" + "=" * 60)
    print("? ?????????????? ???? ????????")
    print("=" * 60)
    sys.exit(1)
