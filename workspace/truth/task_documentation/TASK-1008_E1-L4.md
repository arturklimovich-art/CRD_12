# Task Truth Documentation: E1-L4 Куча-план и Куча-стейт (без rebuild)

## Task Identity
- **Code**: TASK-1008
- **Title**: E1-L4 Куча-план и Куча-стейт (без rebuild)
- **Database ID**: 1008
- **Created**: 2025-11-05 10:48:16
- **Last Updated**: 2025-11-06 17:36:32

## Status Truth
- **Current Status**: done
- **Real Status**: done (VERIFIED CORRECT)
- **Status Verified**: 2025-11-12 11:56:58
- **Status Verified By**: arturklimovich-art

## Implementation Truth

### Concept Clarification
**"Куча-план"** (Heap Plan) = Structured ROADMAP in YAML format
**"Куча-стейт"** (Heap State) = State Persistence System for rebuild survival

This is NOT about runtime task heap/queue, but about:
1. Persistent roadmap structure (plan)
2. State preservation across container rebuilds (state)

### What is Implemented (DONE)

#### 1. Куча-План (ROADMAP YAML Structure)

**Core Files:**
- **ROADMAP_STANDARD.yaml** (5,132 bytes) - Schema definition
  - Version: 2.0
  - Phase: CRD12_FULL_ARCHITECTURE
  - JSON Schema: draft/2020-12
  - Policy: green_paths, spec_binding, ci_spec_guard
  - Blocks: ARCHITECTURE_FOUNDATION, SELF_RECOVERY_SYSTEM (and more)
  - Task structure with spec_ref, dod, metrics

- **GENERAL_PLAN.yaml** (9,164 bytes) - Full roadmap data
- **GENERAL_PLAN_CANONICAL.yaml** (1,594 bytes) - Canonical version
- **ROADMAP_CANONICAL_FROM_DB.yaml** (8,804 bytes) - DB-synced version
- **ROADMAP_CANON_MANIFEST.yaml** (1,343 bytes) - Manifest file

**Markdown Versions:**
- **GENERAL_PLAN_CANONICAL.md** (1,344 bytes)
  - Version: 2.0
  - Updated: 2025-11-12 01:39:40
  - Total tasks: 24 (9 done, 10 in progress, 5 planned)

**SPEC Documentation:**
1. **SYSTEM_ROADMAP_INTEGRITY.md** (1,388 bytes)
   - "🎯 Источник истины = Roadmap = Состояние системы"
   - Architecture, rules, and procedures for roadmap integrity

2. **READMAP_BOOTSTRAP.md** (247 bytes)
   - Steps: create directories, load ROADMAP, set Navigator baseline
   - Events: readmap.loaded

3. **READMAP_MANAGER.md** (242 bytes)
   - Bot v3 Readmap Manager
   - Load & validate ROADMAP.yaml|md
   - DRIFT detector
   - Sync statuses to Navigator by commitSHA

**PowerShell Functions:**
1. **New-TZPlan.ps1** (1,185 bytes)
   - Function: Create DAG plan structure
   - Parameters: Text, Complexity, Tags
   - Returns: PlanId, Tasks, Dependencies
   - Current: Временная заглушка (stub for testing)

2. **Watch-Plan.ps1** (5,370 bytes)
   - Function: Monitor plan execution
   - Parameters: PlanId, PollingInterval, TimeoutMinutes, AutoRefine
   - Features:
     - Polling with timeout
     - Auto-refine enabled/disabled
     - Retry counters
     - Event logging: MONITORING_STARTED

**ROADMAP Artifacts:**
- workspace/artifacts/PLAN_0.md (266 bytes)
- workspace/artifacts/PLAN_20251012_*.md (multiple versions)
- workspace/readmap/revisions/GENERAL_PLAN_2025-11-05.md (9,164 bytes)

**Archive:**
- ROADMAP/archive/20251112_013933/ - old duplicates moved
- workspace/reports/archive/20251112_013933/ - old reports moved

#### 2. Куча-Стейт (State Persistence System)

**Implementation: E1-B15 State Persistence & Volume Setup**

**Test Results (2025-11-10 11:42:24):**
- ✅ ТЕСТ 1: Монтирования volume - ПРОЙДЕН
- ✅ ТЕСТ 2: Доступность volume - ПРОЙДЕН
- ✅ ТЕСТ 3: Запись/чтение данных - ПРОЙДЕН
- ✅ ТЕСТ 4: Пересборка контейнера - ПРОЙДЕН
- ✅ ТЕСТ 5: Сохранение данных - ПРОЙДЕН
- ✅ ТЕСТ 6: Критические пути - ПРОЙДЕН

**Volume Configuration (engineer_b_api):**
1. patches: ./docker_volumes/engineer_b_api/patches → /app/workspace/patches
2. reports: ./docker_volumes/engineer_b_api/reports → /app/workspace/reports
3. snapshots: ./docker_volumes/engineer_b_api/snapshots → /app/workspace/snapshots
4. ADR: ./docker_volumes/engineer_b_api/adr → /app/workspace/ADR
5. logs: ./docker_volumes/engineer_b_api/logs → /app/workspace/logs
6. patches_applied: ./docker_volumes/engineer_b_api/patches_applied → /app/workspace/patches_applied

**State Files:**
- workspace/audit_stage1_20251028-203848/supervisor_state.json (66 bytes)
- workspace/reports/S2_STATE_PERSISTENCE_20251110_114222/S2_STATE_PERSISTENCE_REPORT.md (61 bytes)

**Rebuild Markers:**
- docker_volumes/engineer_b_api/reports/pre_rebuild_marker.txt
- Backups in backups/containers/backup_*/engineer_b_api_app/workspace/reports/

**Guarantees:**
> ✅ Все пути сохраняют данные на хосте и выживают при пересоздании контейнера.

#### 3. Integration

**Roadmap → Database:**
- Schema: eng_it (35 tables/views)
- Tables: roadmap_tasks, roadmap_blocks, roadmap_events
- Sync: ROADMAP_CANONICAL_FROM_DB.yaml (8,804 bytes)

**Roadmap → Navigator:**
- Set Navigator baseline from roadmap
- Sync statuses by commitSHA
- DRIFT detection

**State → Volumes:**
- All critical paths preserved across rebuilds
- No data loss on container recreation
- Tested and verified (6/6 tests passed)

### What is NOT Implemented (TODO)
- New-TZPlan.ps1 full implementation (currently stub)
- Runtime task heap/queue (if needed separately)
- Auto-sync from YAML to DB on file change
- ROADMAP version control integration
- Plan execution engine (beyond Watch-Plan monitoring)

### Partial Implementation (IN PROGRESS)
- New-TZPlan: Basic structure exists, marked as "временная заглушка"

## Database Integration
✅ **INTEGRATED**
- Roadmap data synced to eng_it schema
- Tables: roadmap_tasks, roadmap_blocks, roadmap_events
- File: ROADMAP_CANONICAL_FROM_DB.yaml (8,804 bytes)

## File System Integration
✅ **INTEGRATED**
- ROADMAP directory with 5 YAML files
- Docker volumes for state persistence (6 paths)
- Archive directories for old versions
- Artifact directories for plan snapshots

## Documentation Coverage
- [x] ROADMAP schema documented (ROADMAP_STANDARD.yaml)
- [x] State persistence tested and documented
- [x] SPEC files for roadmap integrity
- [x] PowerShell functions for plan management
- [ ] New-TZPlan full documentation (stub only)
- [x] Volume configuration documented

## AI Agent Knowledge

### For Bot (Orchestrator)
Use New-TZPlan to create DAG plans from user input.
Use Watch-Plan to monitor plan execution with auto-refine.
Load roadmap from ROADMAP_CANONICAL_FROM_DB.yaml.
Check DRIFT against ROADMAP_STANDARD.yaml schema.

### For Engineer_B (Executor)
Your state persists in docker_volumes/engineer_b_api/.
All workspace data survives container rebuild (6 volume paths).
Check pre_rebuild_marker.txt before major operations.
Tasks sourced from roadmap via Navigator.

### For Curator (Analyst)
Monitor roadmap integrity via SYSTEM_ROADMAP_INTEGRITY.md rules.
Verify "🎯 Источник истины = Roadmap = Состояние системы".
Check DRIFT between YAML and DB.
Gate roadmap revisions and TZ changes.

### For Medic (System Health)
Verify state persistence tests (should be 6/6 passed).
Check docker volume mounts are healthy.
Monitor supervisor_state.json for anomalies.
Verify no data loss after rebuilds.

## Truth Verification Checklist
- [x] Status verified (done is correct)
- [x] ROADMAP YAML files documented (5 files)
- [x] ROADMAP schema verified (version 2.0)
- [x] State persistence verified (6/6 tests passed)
- [x] Volume configuration verified (6 paths)
- [x] PowerShell functions exist (New-TZPlan, Watch-Plan)
- [x] SPEC documentation exists (3 files)
- [x] Database integration verified
- [x] Evidence collected

## Last Verification
- **Date**: 2025-11-12 11:56:58 UTC
- **Verified By**: arturklimovich-art
- **Verdict ID**: Not created yet
- **Evidence ID**: Not created yet
- **State**: ROADMAP v2.0, State Persistence 6/6 tests passed

---
Generated: 2025-11-12 11:56:58 UTC
