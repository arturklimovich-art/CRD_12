"""
??????? ?????????: SMA Crossover
??????? ??? ??????????? ??????? SMA ???? ?????????
??????? ??? ??????????? ??????? SMA ???? ?????????
"""
from typing import List, Dict, Optional

class SMAStrategy:
    """????????? ?? ?????? ??????????? ???? ?????????? ???????"""
    
    def __init__(self, fast_period: int = 10, slow_period: int = 30):
        self.fast_period = fast_period
        self.slow_period = slow_period
        self.position = None  # None, "LONG", "SHORT"
        self.entry_price = 0.0
    
    def calculate_sma(self, prices: List[float], period: int) -> Optional[float]:
        """????????? ??????? ?????????? ???????"""
        if len(prices) < period:
            return None
        return sum(prices[-period:]) / period
    
    def on_bar(self, bar: Dict, history: List[Dict]) -> Optional[Dict]:
        """
        ????????? ????? ?????
        
        Returns:
            Dict ? ???????? {"action": "BUY"/"SELL", "price": float} ??? None
        """
        if len(history) < self.slow_period:
            return None  # ???????????? ??????
        
        closes = [b["close"] for b in history]
        
        fast_sma = self.calculate_sma(closes, self.fast_period)
        slow_sma = self.calculate_sma(closes, self.slow_period)
        
        if fast_sma is None or slow_sma is None:
            return None
        
        current_price = bar["close"]
        
        # ?????? ?? ???????: ??????? SMA ?????????? ????????? ????? ?????
        if self.position is None and fast_sma > slow_sma:
            self.position = "LONG"
            self.entry_price = current_price
            return {
                "action": "BUY",
                "price": current_price,
                "fast_sma": fast_sma,
                "slow_sma": slow_sma
            }
        
        # ?????? ?? ???????: ??????? SMA ?????????? ????????? ?????? ????
        elif self.position == "LONG" and fast_sma < slow_sma:
            self.position = None
            pnl = current_price - self.entry_price
            return {
                "action": "SELL",
                "price": current_price,
                "entry_price": self.entry_price,
                "pnl": pnl,
                "fast_sma": fast_sma,
                "slow_sma": slow_sma
            }
        
        return None
