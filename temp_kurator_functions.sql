-- ???????? ??????? Kurator

-- ??????? ???????? ??????? Roadmap
CREATE OR REPLACE FUNCTION nav.kurator_check_roadmap_revision(
    _revision_id UUID,
    _item_id UUID,
    _diff_type TEXT,
    _payload_md_ref TEXT
)
RETURNS TABLE(policy_name TEXT, check_passed BOOLEAN, message TEXT, severity TEXT) AS \$\$
BEGIN
    -- ???????? 1: ?????? ????????
    RETURN QUERY
    SELECT 
        'no_deletions'::TEXT as policy_name,
        _diff_type != 'delete' as check_passed,
        CASE 
            WHEN _diff_type = 'delete' THEN '????????? ???????? ???????? ? Roadmap'
            ELSE 'OK: ???????? ?? ???????? ?????????'
        END as message,
        'blocking'::TEXT as severity;

    -- ???????? 2: ???????????? ?????
    RETURN QUERY
    SELECT 
        'valid_paths'::TEXT as policy_name,
        _payload_md_ref LIKE 'workspace/roadmap/revisions/%' as check_passed,
        CASE 
            WHEN _payload_md_ref NOT LIKE 'workspace/roadmap/revisions/%' THEN '???????????? ???? ? ????? ???????'
            ELSE 'OK: ???? ? ????? ??????? ?????????'
        END as message,
        'blocking'::TEXT as severity;

    -- ???????? 3: ????????????? ????????
    RETURN QUERY
    SELECT 
        'item_exists'::TEXT as policy_name,
        EXISTS(SELECT 1 FROM nav.roadmap_items WHERE item_id = _item_id) as check_passed,
        CASE 
            WHEN NOT EXISTS(SELECT 1 FROM nav.roadmap_items WHERE item_id = _item_id) THEN '??????? Roadmap ?? ??????????'
            ELSE 'OK: ??????? Roadmap ??????????'
        END as message,
        'blocking'::TEXT as severity;
END;
\$\$ LANGUAGE plpgsql;

-- ??????? ???????? ??
CREATE OR REPLACE FUNCTION nav.kurator_check_technical_task(
    _tz_id UUID,
    _title TEXT,
    _artifacts JSONB
)
RETURNS TABLE(policy_name TEXT, check_passed BOOLEAN, message TEXT, severity TEXT) AS \$\$
BEGIN
    -- ???????? 1: ??????? ?????????
    RETURN QUERY
    SELECT 
        'has_acceptance_criteria'::TEXT as policy_name,
        _title IS NOT NULL AND length(trim(_title)) > 0 as check_passed,
        CASE 
            WHEN _title IS NULL OR length(trim(_title)) = 0 THEN '?? ?????? ????? ?????????'
            ELSE 'OK: ????????? ?? ????????????'
        END as message,
        'blocking'::TEXT as severity;

    -- ???????? 2: ???????????? ??????????
    RETURN QUERY
    SELECT 
        'valid_artifacts'::TEXT as policy_name,
        _artifacts IS NULL OR jsonb_typeof(_artifacts) = 'array' as check_passed,
        CASE 
            WHEN _artifacts IS NOT NULL AND jsonb_typeof(_artifacts) != 'array' THEN '????????? ?????? ???? ????????'
            ELSE 'OK: ????????? ?????????'
        END as message,
        'warning'::TEXT as severity;
END;
\$\$ LANGUAGE plpgsql;
